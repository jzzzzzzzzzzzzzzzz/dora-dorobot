# 使用 Ubuntu 20.04 基础镜像
FROM ubuntu:20.04

# 配置时区（避免 apt 安装阻塞）[3](@ref)
ENV DEBIAN_FRONTEND=noninteractive TZ=Etc/UTC
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        wget bzip2 ca-certificates \
        libgl1-mesa-glx libglib2.0-0 libsm6 libxext6 libxrender1 && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# 安装 Miniconda（国内镜像加速）[2,6](@ref)
RUN wget -q https://mirrors.bfsu.edu.cn/anaconda/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh && \
    bash miniconda.sh -b -p /opt/miniconda && \
    rm miniconda.sh

# 设置全局 PATH（避免每个 RUN 重新激活环境）[3,7](@ref)
ENV PATH="/opt/miniconda/bin:$PATH"

# 创建 Conda 环境（从 YAML 文件）
WORKDIR /app
COPY environment.yml .
RUN conda env create -f environment.yml

# 安装纯 pip 依赖（分离 Conda 与 pip 管理）[6](@ref)
COPY requirements.txt .
RUN /opt/miniconda/envs/op/bin/pip install --no-cache-dir -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple


# 设置运行时环境变量（关键！）
ENV PATH="/opt/miniconda/envs/op/bin:$PATH"

# 复制应用文件
COPY operating_platform_server_test.py machine_id.txt nas_sdk.py upload_to_nas.py ./

# 非 root 用户（增强安全性）
RUN useradd -m appuser && chown -R appuser /app
USER appuser

EXPOSE 8080
CMD ["python", "operating_platform_server_test.py"]